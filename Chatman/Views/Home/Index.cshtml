@{
    ViewData["Title"] = "Home";
}

<link rel="stylesheet" href="~/css/index.min.css" />
<link rel="stylesheet" href="~/css/chat_room.min.css" />

<style>
</style>

<div class="home-container">
    <!-- Left Sidebar -->
    <div class="sidebar">
        <!-- User Profile Section -->
        <div class="user-profile">
            <div class="user-info">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ48JWGkSOWJegd_jiLj6C5cz-Ityd6OMLR-w&s" alt="User avatar" class="user-avatar">
                <div class="user-details">
                    <h3>John Doe</h3>
                    <p class="status">Online</p>
                </div>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="搜尋...">
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab-btn active" data-tab="friends">好友列表</button>
            <button class="tab-btn" data-tab="groups">群組列表</button>
        </div>

        <!-- Lists Container -->
        <div class="lists-container">
            <!-- Friends List -->
            <div class="list-section" id="friends-list">
                <div class="list-group">
                    <h4>線上好友</h4>
                    <div class="friend-item">
                        <div class="friend-avatar-container">
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRLe5PABjXc17cjIMOibECLM7ppDwMmiDg6Dw&s" alt="Friend avatar">
                            <span class="status-dot online"></span>
                        </div>
                        <span class="friend-name">Allan</span>
                    </div>
                    <div class="friend-item">
                        <div class="friend-avatar-container">
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRLe5PABjXc17cjIMOibECLM7ppDwMmiDg6Dw&s" alt="Friend avatar">
                            <span class="status-dot online"></span>
                        </div>
                        <span class="friend-name">Jack</span>
                    </div>
                </div>

                <div class="list-group">
                    <h4>離線好友</h4>
                    <div class="friend-item">
                        <div class="friend-avatar-container">
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRLe5PABjXc17cjIMOibECLM7ppDwMmiDg6Dw&s" alt="Friend avatar">
                            <span class="status-dot offline"></span>
                        </div>
                        <span class="friend-name">Jason</span>
                    </div>
                </div>
            </div>

            <!-- Groups List -->
            <div class="list-section hidden" id="groups-list">
                <div class="group-item">
                    <img src="https://via.placeholder.com/32" alt="Group avatar">
                    <div class="group-info">
                        <span class="group-name">群組 1</span>
                        <span class="group-members">4 位成員</span>
                    </div>
                </div>
                <div class="group-item">
                    <img src="https://via.placeholder.com/32" alt="Group avatar">
                    <div class="group-info">
                        <span class="group-name">群組 2</span>
                        <span class="group-members">6 位成員</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Actions -->
        <div class="bottom-actions">
            <!-- 通知按鈕和選單 -->
            <div class="action-container">
                <button class="action-btn"><i class="fas fa-bell"></i></button>
                <div class="popup-menu notification-menu">
                    <div class="menu-header">通知</div>
                    <div class="menu-content">
                        <div class="empty-state">
                            <i class="fas fa-bell-slash"></i>
                            <p>目前沒有新通知</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 訊息按鈕和選單 -->
            <div class="action-container">
                <button class="action-btn"><i class="fas fa-comment"></i></button>
                <div class="popup-menu message-menu">
                    <div class="menu-header">訊息</div>
                    <div class="menu-content">
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <p>沒有未讀訊息</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 設定按鈕和選單 -->
            <div class="action-container">
                <button class="action-btn"><i class="fas fa-cog"></i></button>
                <div class="popup-menu settings-menu">
                    <div class="menu-header">設定</div>
                    <div class="menu-content">
                        <a href="#" class="menu-item">
                            <i class="fas fa-user"></i>
                            <span>基本資料設定</span>
                        </a>
                        <a href="#" class="menu-item">
                            <i class="fas fa-palette"></i>
                            <span>主題設定</span>
                        </a>
                        <a href="#" class="menu-item">
                            <i class="fas fa-bell"></i>
                            <span>通知設定</span>
                        </a>
                        <div class="menu-divider"></div>
                        <a href="javascript: logout();" class="menu-item text-red">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>登出</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- 默認歡迎訊息 -->
        <div class="welcome-message" id="welcome-message">
            <i class="fas fa-comments"></i>
            <p>選擇一個聊天或開始新的對話</p>
        </div>

        <!-- 聊天室區域 -->
        <div class="chat-room hidden" id="chat-room">
            <!-- 聊天室標題 -->
            <div class="chat-header">
                <div class="chat-user-info">
                    <img src="" alt="User avatar" class="chat-user-avatar">
                    <div class="chat-user-details">
                        <h3 class="chat-user-name"></h3>
                        <span class="chat-user-status"></span>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="chat-action-btn">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="chat-action-btn">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="chat-action-btn">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>

            <!-- 聊天記錄區域 -->
            <div class="messages-container">
                <div class="messages-list">
                    <!-- 消息會動態插入這裡 -->
                </div>
            </div>

            <!-- 輸入區域 -->
            <div class="input-area">
                <div class="input-container">
                    <button class="input-action-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                    <input type="text" id="messageInput" placeholder="輸入訊息...">
                    <button class="input-action-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // SignalR 連接
        let connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .build();

        $(document).ready(function() {
            // 初始化
            initializeChat();

            // 載入用戶資訊
            loadUserProfile();

            // 載入好友列表
            loadFriendsList();

            // 啟動 SignalR 連接
            startSignalRConnection();
        });

        // 初始化聊天相關功能
        function initializeChat() {
            // Tab switching
            $('.tab-btn').click(function() {
                $('.tab-btn').removeClass('active');
                $(this).addClass('active');

                const tabId = $(this).data('tab');
                $('.list-section').addClass('hidden');
                $(`#${tabId}-list`).removeClass('hidden');
            });

            // 好友點擊事件
            $(document).on('click', '.friend-item', function() {
                $('.friend-item').removeClass('selected');
                $(this).addClass('selected');
                openChatRoom($(this));
            });
        }

        // 載入用戶個人資料
        function loadUserProfile() {
            const userInfo = JSON.parse(localStorage.getItem('userInfo') || sessionStorage.getItem('userInfo'));
            console.log(userInfo);
            if (userInfo) {
                $('.user-profile .user-details h3').text(userInfo.userName);
                // TODO: 設置用戶頭像
            }
        }

        // 載入好友列表
        function loadFriendsList() {
            $.ajax({
                url: '/Friend/GetFriendsList',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        renderFriendsList(response.data);
                    } else {
                        console.error('載入好友列表失敗：', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('API錯誤：', error);
                }
            });
        }

        // 渲染好友列表
        function renderFriendsList(friends) {
            const onlineFriends = friends.filter(f => f.isOnline);
            const offlineFriends = friends.filter(f => !f.isOnline);

            let onlineHtml = '';
            let offlineHtml = '';

            onlineFriends.forEach(friend => {
                onlineHtml += `
                    <div class="friend-item" data-id="${friend.userId}">
                        <div class="friend-avatar-container">
                            <img src="${friend.avatar || '/images/default-avatar.png'}" alt="${friend.userName}">
                            <span class="status-dot online"></span>
                        </div>
                        <span class="friend-name">${friend.userName}</span>
                    </div>
                `;
            });

            offlineFriends.forEach(friend => {
                offlineHtml += `
                    <div class="friend-item" data-id="${friend.userId}">
                        <div class="friend-avatar-container">
                            <img src="${friend.avatar || '/images/default-avatar.png'}" alt="${friend.userName}">
                            <span class="status-dot offline"></span>
                        </div>
                        <span class="friend-name">${friend.userName}</span>
                    </div>
                `;
            });

            $('#friends-list .list-group:eq(0)').html(`
                <h4>線上好友</h4>
                ${onlineHtml}
            `);

            $('#friends-list .list-group:eq(1)').html(`
                <h4>離線好友</h4>
                ${offlineHtml}
            `);
        }

        // 開啟聊天室
        function openChatRoom(friendElement) {
            const friendId = friendElement.data('id');
            const friendName = friendElement.find('.friend-name').text();
            const friendAvatar = friendElement.find('img').attr('src');
            const isOnline = friendElement.find('.status-dot').hasClass('online');

            // 更新聊天室信息
            $('.chat-user-name').text(friendName);
            $('.chat-user-avatar').attr('src', friendAvatar);
            $('.chat-user-status').text(isOnline ? '在線' : '離線');

            // 隱藏歡迎訊息，顯示聊天室
            $('#welcome-message').addClass('hidden');
            $('#chat-room').removeClass('hidden');

            // 載入聊天記錄
            loadChatHistory(friendId);

            // 在移動設備上，隱藏側邊欄
            if (window.innerWidth <= 768) {
                $('.sidebar').removeClass('active');
            }
        }

        // 載入聊天記錄
        function loadChatHistory(friendId) {
            // TODO: 實作載入聊天記錄的 API 調用
        }

        // 啟動 SignalR 連接
        async function startSignalRConnection() {
            try {
                await connection.start();
                console.log("SignalR Connected.");

                // 連接後註冊當前用戶
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || sessionStorage.getItem('userInfo'));
                if (userInfo) {
                    connection.invoke("RegisterUser", userInfo.userId);
                }
            } catch (err) {
                console.error(err);
                setTimeout(startSignalRConnection, 5000);
            }
        }

        // SignalR 事件處理
        connection.on("FriendOnline", (userId) => {
            $(`.friend-item[data-id="${userId}"] .status-dot`).removeClass('offline').addClass('online');
            // TODO: 移動好友項目到在線區域
        });

        connection.on("FriendOffline", (userId) => {
            $(`.friend-item[data-id="${userId}"] .status-dot`).removeClass('online').addClass('offline');
            // TODO: 移動好友項目到離線區域
        });

        // 發送訊息
        function sendMessage() {
            const message = $('#messageInput').val().trim();
            if (message) {
                const selectedFriend = $('.friend-item.selected');
                const friendId = selectedFriend.data('id');

                // TODO: 實作發送訊息的 API 調用

                // 暫時性的本地渲染
                const messageHtml = `
                    <div class="message sent">
                        <div class="message-content">${message}</div>
                    </div>
                `;
                $('.messages-list').append(messageHtml);
                $('#messageInput').val('');

                // 滾動到底部
                $('.messages-container').scrollTop($('.messages-container')[0].scrollHeight);
            }
        }

        // 註冊發送訊息的事件處理
        $('.input-action-btn i.fa-paper-plane').parent().click(sendMessage);
        $('#messageInput').keypress(function(e) {
            if (e.which == 13) {
                sendMessage();
            }
        });

        function logout() {
            // 清除 cookie
            document.cookie = "auth_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

            // 清除存儲的用戶信息
            localStorage.removeItem('userInfo');
            sessionStorage.removeItem('userInfo');

            // 重定向到登入頁
            window.location.href = '/User/Login';
        }
    </script>
}